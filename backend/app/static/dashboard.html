<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75' fill='%234F46E5'>2</text></svg>">
    <title>2KNOW - Market Dashboard</title>
    <link rel="stylesheet" href="css/style.css?v=3">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="dashboard-page">

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar collapsed">
        <div class="logo-section">
            <img src="assets/logo.png" alt="2KNOW Logo" class="logo-image">
            <div class="logo-subtitle">Market Trend Predictor</div>
        </div>

        <nav class="nav-menu">
            <a href="#" class="nav-item active" onclick="showSection('dashboard', event)">
                <i class="fas fa-home"></i> <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" onclick="showSection('search', event)">
                <i class="fas fa-search"></i> <span>Market Search</span>
            </a>
            <a href="#" class="nav-item" onclick="showSection('trends', event)">
                <i class="fas fa-chart-line"></i> <span>Trend Analysis</span>
            </a>
            <a href="#" class="nav-item" onclick="showSection('profile', event)">
                <i class="fas fa-user"></i> <span>Profile</span>
            </a>
            <a href="#" class="nav-item" onclick="showSection('settings', event)">
                <i class="fas fa-cog"></i> <span>Settings</span>
            </a>
        </nav>

        <div class="user-profile">
            <div class="user-avatar" id="sidebarUserAvatar">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="user-info">
                <div class="user-name" id="sidebarUserName">User</div>
                <div class="user-email" id="sidebarUserEmail">user@example.com</div>
            </div>
            <a href="index.html" class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header">
            <button class="hamburger-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="header-title">
                <h1 id="pageTitle">Market Intelligence Dashboard</h1>
                <p class="subtitle" id="pageSubtitle">Real-time trend analysis for Kenyan markets</p>
            </div>
            <div class="header-actions">
                <div class="date-display">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="currentDate">Loading...</span>
                </div>
                
                <div class="header-profile">
                    <button class="header-icon-btn" onclick="openProfileModal()" title="Profile">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <button class="header-icon-btn" onclick="openContactsModal()" title="Contact Us">
                        <i class="fas fa-phone"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="content-area">
            <!-- DASHBOARD SECTION -->
            <section id="dashboardSection" class="section active">
                <!-- Quick Analyze Card -->
                <div class="quick-analyze-card">
                    <div class="analyze-header">
                        <h3><i class="fas fa-bolt"></i> Quick Market Analysis</h3>
                        <p>Get instant insights for any product in your selected region</p>
                    </div>
                    <div class="analyze-controls">
                        <div class="analyze-input-group">
                            <input type="text" id="dashboardProductInput" placeholder="Enter product name (e.g., maize, smartphones)">
                            <select id="dashboardRegionSelect">
                                <option value="KE">All Kenya</option>
                            </select>
                            <button class="analyze-btn" onclick="analyzeDashboardProduct()">
                                <i class="fas fa-chart-line"></i> Analyze Now
                            </button>
                        </div>
                        <div class="quick-suggestions">
                            <span>Quick picks:</span>
                            <button onclick="quickAnalyze('maize')">Maize</button>
                            <button onclick="quickAnalyze('mobile phones')">Phones</button>
                            <button onclick="quickAnalyze('vegetables')">Vegetables</button>
                            <button onclick="quickAnalyze('second hand cars')">Used Cars</button>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4F46E5, #7C3AED);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Live Trend Score</h3>
                            <div class="stat-value" id="liveScore">--</div>
                            <p>Current market interest</p>
                            <div class="trend-indicator" id="liveTrendIndicator">
                                <i class="fas fa-minus"></i> <span>No data</span>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10B981, #059669);">
                            <i class="fas fa-industry"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Market Sector</h3>
                            <div class="stat-value" id="marketSector">--</div>
                            <p>Primary industry</p>
                            <div class="market-tags" id="marketTags"></div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Active Markets</h3>
                            <div class="stat-value" id="hotMarkets">0</div>
                            <p>High-activity regions</p>
                            <div class="location-info" id="locationInfo">
                                <i class="fas fa-map-pin"></i> Kenya
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                            <i class="fas fa-trend-up"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Overall Score</h3>
                            <div class="stat-value" id="overallScore">--</div>
                            <p>Market potential</p>
                            <div class="score-bar">
                                <div class="score-fill" id="scoreBar"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-history"></i> Historical Trend Analysis</h3>
                        <div class="chart-actions">
                            <select id="timeRange" onchange="updateChartRange()">
                                <option value="12">12 Months</option>
                                <option value="6" selected>6 Months</option>
                                <option value="3">3 Months</option>
                            </select>
                            <button class="chart-btn" onclick="downloadChartPDF()">
                                <i class="fas fa-download"></i> Export PDF
                            </button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="trendChart"></canvas>
                    </div>
                    <div class="chart-footer">
                        <div class="chart-stats">
                            <div class="chart-stat">
                                <span class="stat-label">Peak Interest:</span>
                                <span class="stat-value" id="peakValue">--</span>
                            </div>
                            <div class="chart-stat">
                                <span class="stat-label">Average:</span>
                                <span class="stat-value" id="avgValue">--</span>
                            </div>
                            <div class="chart-stat">
                                <span class="stat-label">Trend:</span>
                                <span class="stat-value" id="trendDirection">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Markets & Insights -->
                <div class="row-grid">
                    <div class="markets-container">
                        <div class="section-header">
                            <h3><i class="fas fa-store"></i> Relevant Physical Markets</h3>
                            <p>Top markets for your product in Kenya</p>
                        </div>
                        <div class="markets-list" id="marketsList">
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <p>Search for a product to see relevant markets</p>
                            </div>
                        </div>
                    </div>

                    <div class="insights-container">
                        <div class="section-header">
                            <h3><i class="fas fa-lightbulb"></i> Market Insights</h3>
                            <p>AI-powered recommendations</p>
                        </div>
                        <div class="insights-list" id="insightsList">
                            <div class="insight-item">
                                <i class="fas fa-info-circle"></i>
                                <p>Search for a product to get market insights</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SEARCH SECTION -->
            <section id="searchSection" class="section">
                <div class="section-header">
                    <h2><i class="fas fa-search"></i> Advanced Market Search</h2>
                    <p>Find real-time market trends for any product across Kenya</p>
                </div>

                <div class="search-container">
                    <div class="search-box-large">
                        <div class="search-input-group">
                            <i class="fas fa-search"></i>
                            <input type="text" id="advancedKeyword" placeholder="Enter product name (e.g., maize, smartphones, cars)">
                            <button onclick="searchFromAdvanced()">
                                <i class="fas fa-chart-line"></i> Analyze
                            </button>
                        </div>
                        <div class="search-suggestions">
                            <p><i class="fas fa-fire" style="margin-right: 6px; color: var(--warning);"></i>Trending Searches</p>
                            <div class="suggestion-tags">
                                <span class="tag" onclick="quickSearch('maize')">Maize</span>
                                <span class="tag" onclick="quickSearch('mobile phones')">Mobile Phones</span>
                                <span class="tag" onclick="quickSearch('second hand cars')">Used Cars</span>
                                <span class="tag" onclick="quickSearch('rice')">Rice</span>
                                <span class="tag" onclick="quickSearch('laptops')">Laptops</span>
                                <span class="tag" onclick="quickSearch('vegetables')">Vegetables</span>
                            </div>
                        </div>
                    </div>

                    <div class="search-filters">
                        <h3><i class="fas fa-sliders-h" style="margin-right: 6px;"></i>Filters</h3>
                        <div class="filter-group">
                            <label for="regionFilter"><i class="fas fa-map-marker-alt"></i> Region</label>
                            <select id="regionFilter">
                                <option value="KE">All Kenya</option>
                            </select>
                                <option value="Muranga">Muranga</option>
                                <option value="Kajiado">Kajiado</option>
                                <option value="Isiolo">Isiolo</option>
                                <option value="Malindi">Malindi</option>
                                <option value="Lamu">Lamu</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="timeFilter"><i class="fas fa-calendar"></i> Time Range</label>
                            <select id="timeFilter">
                                <option value="12">12 Months</option>
                                <option value="6" selected>6 Months</option>
                                <option value="3">3 Months</option>
                                <option value="1">1 Month</option>
                            </select>
                        </div>
                        <button class="apply-filters" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                    </div>

                    <div class="search-results" id="searchResults">
                        <div class="results-placeholder">
                            <i class="fas fa-chart-bar"></i>
                            <h3>Search for Products</h3>
                            <p>Enter a product name above to analyze market trends and get insights</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TREND ANALYSIS SECTION -->
            <section id="trendsSection" class="section">
                <div class="section-header">
                    <h2><i class="fas fa-chart-line"></i> Trend Analysis</h2>
                    <p>Detailed historical analysis and market comparisons</p>
                </div>

                <div class="trends-container">
                    <div class="trend-controls">
                        <h3><i class="fas fa-exchange-alt"></i> Compare Market Trends</h3>
                        <div class="comparison-inputs">
                            <input type="text" id="trend1" placeholder="Enter first product (e.g., maize)" value="maize">
                            <input type="text" id="trend2" placeholder="Enter second product (e.g., rice)" value="rice">
                            <button class="comparison-btn" onclick="compareTrends()">
                                <i class="fas fa-search"></i> Compare
                            </button>
                        </div>
                    </div>

                    <div class="trend-charts">
                        <h3><i class="fas fa-chart-area"></i> Market Trends Comparison</h3>
                        <div class="charts-grid">
                            <div class="chart-item">
                                <h4>Product 1 Trend</h4>
                                <canvas id="trendChart1"></canvas>
                            </div>
                            <div class="chart-item">
                                <h4>Product 2 Trend</h4>
                                <canvas id="trendChart2"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="trend-insights">
                        <h3><i class="fas fa-star"></i> Comparison Analysis</h3>
                        <div id="comparisonInsights" class="insights-comparison">
                            <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 40px; width: 100%;">
                                <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                                Compare two products to see detailed insights and analysis
                            </p>
                        </div>
                    </div>

                    <div class="trend-history">
                        <h3><i class="fas fa-history"></i> Search History</h3>
                        <div class="history-timeline" id="searchHistory">
                            <p style="color: var(--gray); text-align: center; padding: 20px;">
                                Your searches will appear here
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PROFILE SECTION -->
            <section id="profileSection" class="section">
                <div class="section-header">
                    <h2><i class="fas fa-user"></i> Your Profile</h2>
                    <p>Manage your account and preferences</p>
                </div>

                <div class="profile-container">
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar-large" id="profileAvatarLarge">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="profile-info">
                                <h3 id="profileName">Loading...</h3>
                                <p id="profileEmail">Loading...</p>
                                <p id="profileAbout" class="profile-about">--</p>
                                <div class="member-since">
                                    <i class="fas fa-calendar"></i>
                                    Member since: <span id="memberSince">--</span>
                                </div>
                            </div>
                        </div>

                        <div class="profile-stats">
                            <div class="profile-stat">
                                <h4>Searches Made</h4>
                                <div class="stat-number" id="searchCount">0</div>
                            </div>
                            <div class="profile-stat">
                                <h4>Market Reports</h4>
                                <div class="stat-number" id="reportCount">0</div>
                            </div>
                            <div class="profile-stat">
                                <h4>Account Level</h4>
                                <div class="stat-number">Basic</div>
                            </div>
                        </div>

                        <div class="profile-actions">
                            <button class="profile-btn" onclick="uploadProfilePicture()">
                                <i class="fas fa-camera"></i> Change Picture
                            </button>
                            <button class="profile-btn" onclick="showEditProfile()">
                                <i class="fas fa-edit"></i> Edit Profile
                            </button>
                            <button class="profile-btn" onclick="changePassword()">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                            <button class="profile-btn" onclick="exportUserDataPDF()">
                                <i class="fas fa-download"></i> Export Data (PDF)
                            </button>
                        </div>
                        
                        <!-- Hidden file input for profile picture -->
                        <input type="file" id="profilePictureInput" accept="image/*" style="display: none;" onchange="handleProfilePictureUpload(event)">
                    </div>

                    <div class="profile-details">
                        <div class="detail-card">
                            <h3><i class="fas fa-history"></i> Recent Activity</h3>
                            <div class="activity-list" id="activityList">
                                <!-- Will be populated -->
                            </div>
                        </div>

                        <div class="detail-card">
                            <h3><i class="fas fa-chart-line"></i> Your Top Searches</h3>
                            <div class="top-searches" id="topSearches">
                                <!-- Will be populated -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SETTINGS SECTION -->
            <section id="settingsSection" class="section">
                <div class="section-header">
                    <h2><i class="fas fa-cog"></i> Settings</h2>
                    <p>Configure your 2KNOW experience</p>
                </div>

                <div class="settings-container">
                    <div class="settings-tabs">
                        <button class="settings-tab active" onclick="showSettingsTab('general', event)">
                            <i class="fas fa-sliders-h"></i> General
                        </button>
                    </div>

                    <div class="settings-content">
                        <div id="generalSettings" class="settings-tab-content active">
                            <h3>General Settings</h3>
                            <div class="setting-item">
                                <label for="themeSetting">Theme</label>
                                <select id="themeSetting" onchange="changeTheme(this.value)">
                                    <option value="light">Light Mode</option>
                                    <option value="dark">Dark Mode</option>
                                    <option value="purple">Purple Theme</option>
                                    <option value="ocean">Ocean Theme</option>
                                    <option value="forest">Forest Theme</option>
                                    <option value="sunset">Sunset Theme</option>
                                    <option value="auto">Auto (System)</option>
                                </select>
                            </div>
                           
                            <div class="setting-item">
                                <label for="regionSetting">Default Region</label>
                                <select id="regionSetting">
                                    <option value="KE">All Kenya</option>
                                </select>
                            </div>
                            <button class="save-settings" onclick="saveSettings()">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Analyzing market trends...</p>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <!-- Scripts -->
    <script src="js/config.js?v=3"></script>
    <script src="js/theme.js?v=3"></script>
    <script src="js/auth.js?v=3"></script>
    <script src="js/dashboard.js?v=3"></script>
    <script src="js/charts.js?v=3"></script>
    <script src="js/markets.js?v=3"></script>
    
    <!-- Initialize dashboard -->
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            
            // Check if user is logged in
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            
            // Load user info
            if (window.loadUserInfo) {
                window.loadUserInfo();
            }
            
            // Set current date
            updateCurrentDate();
            
            // Initialize charts
            if (window.initChart) {
                window.initChart();
            }
            
            // Initialize market directory
            if (window.initMarketDirectory) {
                window.initMarketDirectory();
            }
            
            // Load search history
            if (window.loadSearchHistory) {
                window.loadSearchHistory();
            }
            
            // Load saved settings
            if (window.loadSavedSettings) {
                window.loadSavedSettings();
            }
            
            // Set up auto-refresh for date
            setInterval(updateCurrentDate, 60000);
            
            // Initialize theme
            if (window.initializeTheme) {
                window.initializeTheme();
            }
        });
        
        function updateCurrentDate() {
            const now = new Date();
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                dateElement.textContent = 
                    now.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }) + ' • ' + now.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
            }
        }
        
        // Analyze with selected region
        function analyzeWithRegion() {
            // Get region from the dashboard section's region selector
            const dashboardRegion = document.getElementById('dashboardRegionSelect');
            const region = dashboardRegion ? dashboardRegion.value : 'KE';
            const keyword = document.getElementById('keywordInput').value.trim();
            
            if (!keyword) {
                showToast('Please enter a product to analyze', 'warning');
                document.getElementById('keywordInput').focus();
                return;
            }
            
            performSearch(keyword, region, 'dashboard');
        }
        
        // Quick analyze from dashboard
        function analyzeDashboardProduct() {
            const product = document.getElementById('dashboardProductInput').value.trim();
            // Get region from the dashboard section's region selector
            const dashboardRegion = document.getElementById('dashboardRegionSelect');
            const region = dashboardRegion ? dashboardRegion.value : 'KE';
            
            if (!product) {
                showToast('Please enter a product name', 'warning');
                document.getElementById('dashboardProductInput').focus();
                return;
            }
            
            // Update main search input (if present)
            const mainKeywordEl = document.getElementById('keywordInput');
            if (mainKeywordEl) mainKeywordEl.value = product;
            
            // Perform analysis
            performSearch(product, region, 'dashboard');
        }
        
        // Quick analyze function
        function quickAnalyze(product) {
            // Get region from the dashboard section's region selector
            const dashboardRegion = document.getElementById('dashboardRegionSelect');
            const region = dashboardRegion ? dashboardRegion.value : 'KE';
            
            document.getElementById('dashboardProductInput').value = product;
            const mainKeywordEl = document.getElementById('keywordInput');
            if (mainKeywordEl) mainKeywordEl.value = product;
            
            performSearch(product, region, 'dashboard');
        }
        
        // Export chart as PDF
        function downloadChartPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const product = document.getElementById('keywordInput').value || 'Market Analysis';
            const region = document.getElementById('dashboardRegion').value || 'Kenya';
            const date = new Date().toLocaleDateString();
            
            // Title
            doc.setFontSize(20);
            doc.text(`2KNOW Market Analysis: ${product}`, 20, 20);
            
            // Subtitle
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(`Region: ${region} | Date: ${date}`, 20, 30);
            
            // Add some sample content
            doc.setFontSize(14);
            doc.setTextColor(0);
            doc.text('Market Analysis Summary:', 20, 50);
            
            doc.setFontSize(12);
            const summary = [
                `Product: ${product}`,
                `Region: ${region}`,
                `Overall Score: ${document.getElementById('overallScore')?.textContent || 'N/A'}`,
                `Market Sector: ${document.getElementById('marketSector')?.textContent || 'N/A'}`,
                `Active Markets: ${document.getElementById('hotMarkets')?.textContent || '0'}`,
                `Trend Direction: ${document.getElementById('trendDirection')?.textContent || 'N/A'}`
            ];
            
            summary.forEach((line, index) => {
                doc.text(line, 20, 70 + (index * 10));
            });
            
            // Save PDF
            doc.save(`2KNOW-${product.replace(/\s+/g, '-')}-${date}.pdf`);
            
            showToast('Chart data exported as PDF successfully', 'success');
        }
        
        // Export user data as PDF
        function exportUserDataPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const userName = localStorage.getItem('user_name') || 'User';
            const userEmail = localStorage.getItem('user_email') || 'N/A';
            const memberSince = localStorage.getItem('member_since') || new Date().toISOString().split('T')[0];
            const history = JSON.parse(localStorage.getItem('search_history') || '[]');
            
            let yPosition = 20;
            
            // Title
            doc.setFontSize(20);
            doc.text('2KNOW User Data Export', 20, yPosition);
            yPosition += 15;
            
            // Export date
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Export Date: ${new Date().toLocaleString()}`, 20, yPosition);
            yPosition += 10;
            
            // Profile Section
            doc.setTextColor(0);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Profile Information', 20, yPosition);
            yPosition += 8;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Name: ${userName}`, 20, yPosition);
            yPosition += 7;
            doc.text(`Email: ${userEmail}`, 20, yPosition);
            yPosition += 7;
            doc.text(`Member Since: ${new Date(memberSince).toLocaleDateString()}`, 20, yPosition);
            yPosition += 12;
            
            // Search History
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`Search History (${history.length} searches)`, 20, yPosition);
            yPosition += 8;
            
            doc.setFontSize(10);
            if (history.length > 0) {
                history.forEach((search, index) => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    const searchText = `${index + 1}. "${search.keyword}" - ${new Date(search.timestamp).toLocaleDateString()} (Score: ${search.score}%)`;
                    doc.text(searchText, 20, yPosition);
                    yPosition += 7;
                });
            } else {
                doc.text('No search history available', 20, yPosition);
                yPosition += 7;
            }
            
            // Footer
            doc.setFontSize(9);
            doc.setTextColor(150);
            doc.text('This is a secure export of your 2KNOW account data', 20, 285);
            
            // Save PDF
            doc.save(`2KNOW-user-export-${new Date().toISOString().split('T')[0]}.pdf`);
            
            showToast('User data exported as PDF successfully', 'success');
        }
        
        // Delete account data
        function deleteAccountData() {
            if (confirm('Are you sure you want to delete all your account data? This action cannot be undone.')) {
                localStorage.removeItem('search_history');
                localStorage.removeItem('profile_picture');
                localStorage.removeItem('user_bio');
                
                showToast('Account data deleted successfully', 'success');
                
                // Refresh profile data
                if (window.loadProfileData) {
                    window.loadProfileData();
                }
            }
        }
    </script>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Profile Settings</h2>
                <button type="button" class="modal-close" onclick="closeProfileModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="profile-section">
                    <div class="profile-avatar-large" id="profileAvatarModal">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <button class="btn-upload" onclick="uploadProfilePicture()">Change Profile Picture</button>
                    <input type="file" id="profilePictureInputModal" style="display: none;" accept="image/*" onchange="handleProfilePictureUpload(event)">
                </div>
                
                <div class="profile-info-section">
                    <div class="info-item">
                        <label>Full Name</label>
                        <p id="modalProfileName">Loading...</p>
                    </div>
                    <div class="info-item">
                        <label>Email</label>
                        <p id="modalProfileEmail">Loading...</p>
                    </div>
                    <div class="info-item">
                        <label>Member Since</label>
                        <p id="modalMemberSince">Loading...</p>
                    </div>
                    <div class="info-item">
                        <label>Searches Conducted</label>
                        <p id="modalSearchCount">0</p>
                    </div>
                    <div class="info-item">
                        <label>About</label>
                        <p id="modalProfileBio">Loading...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">Close</button>
                <button type="button" class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Contacts Modal -->
    <div id="contactsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Contact Information</h2>
                <button class="modal-close" onclick="closeContactsModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="contacts-section">
                    <div class="contact-card">
                        <div class="contact-icon" style="background: linear-gradient(135deg, #EA4335, #F59E0B);">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="contact-info">
                            <h3>Email</h3>
                            <a href="mailto:victormure6@gmail.com" class="contact-link">victormure6@gmail.com</a>
                        </div>
                    </div>
                    
                    <div class="contact-card">
                        <div class="contact-icon" style="background: linear-gradient(135deg, #25D366, #128C7E);">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="contact-info">
                            <h3>WhatsApp</h3>
                            <a href="https://wa.me/254116094935" target="_blank" class="contact-link">+254 116094935</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeContactsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>

</body>
</html>